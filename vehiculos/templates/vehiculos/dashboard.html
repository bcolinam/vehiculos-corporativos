{% extends "base.html" %}

{% block title %}SGV | Panel de Control{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --secondary: #10b981;
        --bg: #f8fafc;
        --card: #ffffff;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
                  0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: var(--card);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .metric-card h4 {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .metric-value {
        display: block;
        font-size: 1.9rem;
        font-weight: 700;
        margin-top: 0.3rem;
    }

    .charts-container {
        display: grid;
        grid-template-columns: 1.6fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: var(--card);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
    }

    .chart-card h3 {
        margin: top 0;
        margin-bottom: 1.25rem;
        font-size: 1rem;
        font-weight: 600;
    }

    .canvas-wrapper {
        position: relative;
        height: 300px;
    }

    .page-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }

    @media (max-width: 1024px) {
        .charts-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Panel de Control</h2>
        <span class="badge bg-light text-dark border p-2">
            Usuario: {{ user.get_full_name|default:user.username }} 
            {% if user.is_staff %}(Admin){% endif %}
        </span>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div>
                <h4>Total vehículos</h4>
                <span class="metric-value">{{ metricas.total|default:0 }}</span>
            </div>
            <i data-lucide="database" class="text-primary"></i>
        </div>
        <div class="metric-card">
            <div>
                <h4>Activos</h4>
                <span class="metric-value" style="color: var(--secondary)">
                    {{ metricas.activos|default:0 }}
                </span>
            </div>
            <i data-lucide="check-circle" style="color: var(--secondary)"></i>
        </div>
        <div class="metric-card">
            <div>
                <h4>Inactivos</h4>
                <span class="metric-value" style="color: #ef4444">
                    {{ metricas.inactivos|default:0 }}
                </span>
            </div>
            <i data-lucide="alert-circle" style="color: #ef4444"></i>
        </div>
    </div>

    <div class="charts-container">
        {% if user.is_staff %}
        <div class="chart-card">
            <h3>Vehículos por usuario</h3>
            <div class="canvas-wrapper">
                <canvas id="barChart"></canvas>
            </div>
        </div>
        {% endif %}

        <div class="chart-card {% if not user.is_staff %}w-100{% endif %}">
            <h3>Estado de Disponibilidad</h3>
            <div class="canvas-wrapper">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="page-actions">
        <a href="{% url 'vehiculos:detalle_vehiculos' %}" class="btn btn-outline-secondary d-flex align-items-center gap-2">
            <i data-lucide="list" style="width: 18px"></i> Ver listado completo
        </a>
        
        {% if user.is_staff %}
        <a href="{% url 'vehiculos:registro' %}" class="btn btn-primary d-flex align-items-center gap-2">
            <i data-lucide="plus-circle" style="width: 18px"></i> Nuevo vehículo
        </a>
        {% endif %}
    </div>
</div>

{% if user.is_staff %}
    {{ metricas.stats_usuarios|json_script:"datos-usuarios" }}
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    lucide.createIcons();

    // Lógica para Gráfico de Barras (Solo si el script existe en el DOM)
    const scriptDatos = document.getElementById('datos-usuarios');
    if (scriptDatos) {
        const datosUsuarios = JSON.parse(scriptDatos.textContent);
        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: datosUsuarios.map(d => d.usuario__username || 'N/A'),
                datasets: [{
                    label: 'Vehículos',
                    data: datosUsuarios.map(d => d.total || 0),
                    backgroundColor: '#4f46e5',
                    borderRadius: 6,
                    barThickness: 25
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // Gráfico de Dona (Para todos)
    new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: {
            labels: ['Activos', 'Inactivos'],
            datasets: [{
                data: [
                    {{ metricas.activos|default:0 }},
                    {{ metricas.inactivos|default:0 }}
                ],
                backgroundColor: ['#10b981', '#ef4444'],
                hoverOffset: 4,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom', labels: { padding: 20 } }
            }
        }
    });
</script>
{% endblock %}